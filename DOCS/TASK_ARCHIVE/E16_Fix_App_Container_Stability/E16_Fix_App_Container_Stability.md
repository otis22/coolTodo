# Task E16: Исправить стабильность app контейнера (PHP-FPM)

**Статус**: Completed ✅  
**Начало**: 2025-12-01  
**Завершение**: 2025-12-01  
**Приоритет**: High  
**Оценка**: 0.5 дня

## Описание

App контейнер (PHP-FPM) периодически перезапускается или не запускается из-за проблем с конфигурацией или путями. Хотя сейчас контейнер работает, были случаи, когда он не запускался с ошибкой "php-fpm: not found".

## Проблема

**Текущая ситуация**:
- Контейнер `cooltodo_app` иногда не запускается
- Ошибка: `/usr/local/bin/docker-php-entrypoint: 9: exec: php-fpm: not found`
- Контейнер постоянно перезапускается (restart loop)
- Nginx возвращает 502 Bad Gateway, так как не может подключиться к PHP-FPM

**Логи** (из истории):
```
cooltodo_app  | /usr/local/bin/docker-php-entrypoint: 9: exec: php-fpm: not found
```

**Текущий статус**:
- После пересборки контейнер работает
- PHP-FPM запускается успешно: "ready to handle connections"
- Но проблема может повториться при изменении конфигурации

## Зависимости

- [x] A3: Настроить Docker окружение (Completed ✅)
- [x] E6: Исправить перезапуск app контейнера (Completed ✅) - но проблема может повториться

## Требования

### Цель

Обеспечить стабильную работу app контейнера с PHP-FPM, чтобы избежать проблем с запуском и перезапуском.

### Критерии приемки

✅ App контейнер запускается стабильно  
✅ PHP-FPM доступен на порту 9000  
✅ Nginx может подключиться к PHP-FPM (нет 502 ошибок)  
✅ Контейнер не перезапускается в цикле  
✅ Команда `php-fpm` доступна в контейнере  
✅ Все тесты проходят

## План выполнения

### Шаг 1: Анализ проблемы
- [x] Проверить Dockerfile.dev.fpm ✅
- [x] Проверить docker-compose.yml конфигурацию ✅
- [x] Проверить логи контейнера ✅
- [x] Определить причину проблемы с `php-fpm: not found` ✅

**Причина**: `php-fpm` находится в `/usr/local/sbin/php-fpm`, но при запуске с пользователем 1000:1000 PATH может не включать `/usr/local/sbin`.

### Шаг 2: Исправление
- [x] Проверить, что `php-fpm` установлен в Dockerfile.dev.fpm ✅
- [x] Убедиться, что команда `php-fpm` доступна в PATH ✅ (находится в `/usr/local/sbin/php-fpm`)
- [x] Проверить конфигурацию PHP-FPM ✅
- [x] Добавить healthcheck для контейнера ✅
- [x] Обновить docker-compose.yml при необходимости ✅

**Изменения**:
- Использован полный путь: `command: /usr/local/sbin/php-fpm -F -O`
- Добавлен healthcheck для мониторинга состояния PHP-FPM
- Флаги `-F` (foreground) и `-O` (оптимизация) для стабильной работы

### Шаг 3: Проверка
- [x] Пересобрать контейнер: `docker compose build app` (не требуется, только перезапуск)
- [x] Запустить контейнер: `docker compose up -d app` ✅
- [x] Проверить логи: `docker compose logs app` ✅
- [x] Проверить доступность PHP-FPM ✅
- [x] Проверить, что nginx может подключиться ✅
- [x] Проверить API: `curl http://localhost:8080/api/todos` ✅

## Выполненные изменения

### Обновлен docker-compose.yml

**Изменения для сервиса `app`**:
```yaml
command: /usr/local/sbin/php-fpm -F -O  # Полный путь + флаги
healthcheck:
  test: ["CMD-SHELL", "php -r '$$sock = @fsockopen(\"127.0.0.1\", 9000); if ($$sock) { fclose($$sock); exit(0); } exit(1);'"]
  interval: 10s
  timeout: 5s
  retries: 3
  start_period: 10s
```

**Примечание**: Используется `$$` для экранирования переменных в Docker Compose YAML.

**Преимущества**:
- Использование полного пути гарантирует, что `php-fpm` будет найден
- Флаги `-F -O` обеспечивают стабильную работу в foreground режиме
- Healthcheck позволяет Docker отслеживать состояние контейнера
- Healthcheck проверяет доступность PHP-FPM на порту 9000

### Проверка совместимости с CI

✅ **CI workflow не использует docker-compose** - изменения безопасны:
- CI использует нативный PHP через `shivammathur/setup-php@v2`
- CI использует GitHub Actions services для MySQL
- Изменения в docker-compose.yml не влияют на CI workflow

## Результаты проверки

✅ **Контейнер запускается стабильно**: использует полный путь `/usr/local/sbin/php-fpm`  
✅ **PHP-FPM доступен**: контейнер показывает статус `(healthy)`  
✅ **Nginx подключается**: API доступен через `http://localhost:8080/api/todos`  
✅ **Healthcheck работает**: контейнер проходит проверку здоровья  
✅ **Нет перезапусков в цикле**: контейнер стабильно работает  
✅ **Команда php-fpm доступна**: находится в `/usr/local/sbin/php-fpm`

**Задача выполнена успешно!** ✅

## Технические детали

### Текущая конфигурация

**Dockerfile.dev.fpm**:
```dockerfile
FROM php:8.3-fpm
# ... установка зависимостей ...
WORKDIR /var/www/project/backend
```

**docker-compose.yml**:
```yaml
services:
  app:
    build:
      dockerfile: Dockerfile.dev.fpm
    command: php-fpm
    user: "${UID:-1000}:${GID:-1000}"
```

### Возможные причины

1. **Проблема с PATH**: `php-fpm` может быть не в PATH при запуске с пользователем 1000:1000
2. **Проблема с entrypoint**: `docker-php-entrypoint` может не находить `php-fpm`
3. **Проблема с правами**: Пользователь 1000:1000 может не иметь доступа к `php-fpm`
4. **Проблема с конфигурацией**: PHP-FPM конфигурация может быть неправильной

### Рекомендуемые решения

1. **Использовать полный путь к php-fpm**:
   ```yaml
   command: /usr/local/sbin/php-fpm
   ```

2. **Проверить и исправить entrypoint**:
   ```dockerfile
   # В Dockerfile.dev.fpm
   RUN which php-fpm || echo "php-fpm not found"
   ```

3. **Добавить healthcheck**:
   ```yaml
   healthcheck:
     test: ["CMD", "php-fpm-healthcheck"]
     interval: 10s
     timeout: 5s
     retries: 3
   ```

4. **Использовать правильную команду запуска**:
   ```yaml
   command: php-fpm -F -O
   # -F: запуск в foreground
   # -O: оптимизация для разработки
   ```

## Прогресс

Создано: 2025-12-01

### Выполненные действия

1. **Анализ проблемы** ✅
   - Проверен Dockerfile.dev.fpm - использует `FROM php:8.3-fpm`
   - Проверена конфигурация docker-compose.yml
   - Контейнер сейчас работает после пересборки

### Следующие шаги

- [ ] Определить точную причину проблемы "php-fpm: not found"
- [ ] Добавить healthcheck для мониторинга
- [ ] Улучшить конфигурацию запуска PHP-FPM
- [ ] Добавить проверки в CI/CD

## Примечания

- Проблема может быть связана с тем, как docker-php-entrypoint обрабатывает команду `php-fpm`
- Возможно, нужно использовать полный путь или другой способ запуска
- Приоритет High, так как блокирует работу backend API

