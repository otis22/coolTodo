# Task B5.1: Исправить окружение БД для feature тестов

**Статус**: Completed ✅  
**Начало**: 2025-01-27  
**Завершено**: 2025-01-27  
**Приоритет**: High  
**Оценка**: 0.5 дня

## Описание

Исправить проблему с выполнением миграций в feature тестах. RefreshDatabase не может выполнить `migrate:fresh` из-за проблем с конфигурацией или доступом к БД.

## Проблема

При запуске feature тестов с `RefreshDatabase` trait возникает ошибка:
```
SQLSTATE[HY000] [2002] Connection refused
```

Или:
```
Unable to detect application namespace
```

**Симптомы**:
- Feature тесты не могут выполнить миграции
- RefreshDatabase не работает
- Тесты падают с ошибками подключения к БД

## Зависимости

- [x] B5: Реализовать API контроллеры (In Progress)
- [x] B2: Создать миграции БД (Completed ✅)

## Требования

### Проблемы для решения

1. **Конфигурация тестовой БД**
   - Проверить настройки в `phpunit.xml`
   - Проверить переменные окружения для тестов
   - Убедиться, что БД `cooltodo_test` существует

2. **Доступ к БД из Docker**
   - Проверить подключение к MySQL из контейнера
   - Проверить права доступа пользователя БД
   - Убедиться, что миграции могут выполняться

3. **RefreshDatabase trait**
   - Проверить, что миграции находятся в правильной директории
   - Убедиться, что Laravel может найти миграции
   - Проверить пути к миграциям в конфигурации

## План выполнения

### Шаг 1: Диагностика проблемы
- [x] Проверить подключение к БД из контейнера
- [x] Проверить существование БД `cooltodo_test`
- [x] Проверить права доступа пользователя БД
- [x] Проверить логи ошибок

### Шаг 2: Исправление конфигурации
- [x] Обновить настройки БД для тестов
- [x] Настроить переменные окружения
- [x] Исправить пути к миграциям (если необходимо)

### Шаг 3: Проверка
- [x] Запустить feature тесты
- [x] Убедиться, что RefreshDatabase работает
- [x] Проверить, что все тесты проходят

## Критерии приемки

✅ Feature тесты могут выполнять миграции  
✅ RefreshDatabase работает корректно  
✅ Все feature тесты проходят  
✅ БД `cooltodo_test` создается и используется правильно

## Технические детали

### Текущая конфигурация

**phpunit.xml**:
- `DB_DATABASE=cooltodo_test`
- `DB_CONNECTION=mysql`

**Проблемные места**:
- Возможно, БД не существует
- Возможно, неправильные credentials
- Возможно, проблемы с путями к миграциям

### Возможные решения

1. **Создать БД вручную**:
   ```sql
   CREATE DATABASE cooltodo_test;
   GRANT ALL PRIVILEGES ON cooltodo_test.* TO 'cooltodo'@'%';
   ```

2. **Использовать DatabaseTransactions вместо RefreshDatabase** (если БД уже существует)

3. **Настроить .env.testing** для тестового окружения

4. **Исправить пути к миграциям** в конфигурации Laravel

## Прогресс

Создано: 2025-01-27  
Завершено: 2025-01-27

### Выполненные действия

1. **Создана БД `cooltodo_test`** ✅
   - БД создана в MySQL
   - Права доступа настроены для пользователя `cooltodo`

2. **Обновлен `phpunit.xml`** ✅
   - Добавлены переменные окружения для БД:
     - `DB_HOST=mysql`
     - `DB_PORT=3306`
     - `DB_DATABASE=cooltodo_test`
     - `DB_USERNAME=cooltodo`
     - `DB_PASSWORD=root`

3. **Исправлены типы параметров в контроллере** ✅
   - Изменены типы параметров `$id` с `int` на `string` (Laravel передает строки)
   - Добавлено преобразование `(int) $id` перед вызовом Use Cases
   - Добавлены ограничения `->where('id', '[0-9]+')` в routes

### Результаты

- ✅ Feature тесты могут выполнять миграции
- ✅ RefreshDatabase работает корректно
- ✅ Все 11 feature тестов проходят (29 assertions)
- ✅ БД `cooltodo_test` создается и используется правильно
- ✅ PHPStan level 9 без ошибок

## Заметки

- Проблема блокирует выполнение feature тестов для B5
- После исправления можно будет завершить B5 полностью
- Возможно, потребуется настройка Docker для автоматического создания тестовой БД

