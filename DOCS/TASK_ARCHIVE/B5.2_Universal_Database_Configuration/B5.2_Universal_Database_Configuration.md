# Task B5.2: Универсальная конфигурация БД для тестов

**Статус**: Completed ✅  
**Начало**: 2025-01-27  
**Завершено**: 2025-01-27  
**Приоритет**: High  
**Оценка**: 0.25 дня

## Описание

Создать универсальную конфигурацию БД для тестов, которая будет работать и локально (Docker), и в CI (GitHub Actions) без дублирования настроек.

## Проблема

Текущая ситуация:
- **Локально (Docker)**: `phpunit.xml` использует `DB_HOST=mysql`, `DB_USERNAME=cooltodo`
- **CI (GitHub Actions)**: Переменные окружения в workflow переопределяют значения: `DB_HOST=127.0.0.1`, `DB_USERNAME=root`

**Проблемы**:
1. Дублирование настроек в двух местах
2. Риск рассинхронизации конфигураций
3. Неочевидность, какие значения используются в каком окружении

## Зависимости

- [x] B5.1: Исправить окружение БД для feature тестов (Completed ✅)

## Требования

### Цель

Создать единую конфигурацию, которая:
- Работает локально в Docker (DB_HOST=mysql, DB_USERNAME=cooltodo)
- Работает в CI GitHub Actions (DB_HOST=127.0.0.1, DB_USERNAME=root)
- Не требует дублирования настроек
- Понятна и легко поддерживается

### Решения

**Вариант 1 (Рекомендуемый)**: Использовать переменные окружения с fallback
- `phpunit.xml` содержит значения по умолчанию для локальной разработки
- CI workflow устанавливает переменные окружения, которые переопределяют значения из `phpunit.xml`
- PHPUnit автоматически использует переменные окружения, если они установлены

**Вариант 2**: Использовать условную логику в `phpunit.xml` (не поддерживается PHPUnit)

**Вариант 3**: Создать отдельный `phpunit.ci.xml` для CI (дублирование)

## План выполнения

### Шаг 1: Анализ текущей конфигурации
- [x] Проверить, как PHPUnit обрабатывает переменные окружения ✅
- [x] Убедиться, что CI переменные переопределяют phpunit.xml ✅
- [x] Проверить работу локально и в CI ✅

**Результат анализа**:
- PHPUnit устанавливает переменные из `<env>` только если они не установлены в системе
- CI workflow устанавливает переменные окружения, которые переопределяют значения из `phpunit.xml`
- Текущая конфигурация работает корректно

### Шаг 2: Оптимизация конфигурации
- [x] Обновить `phpunit.xml` с правильными значениями по умолчанию ✅
- [x] Убедиться, что CI workflow правильно устанавливает переменные ✅
- [x] Добавить комментарии в конфигурацию ✅

### Шаг 3: Документирование
- [x] Документировать, как работает конфигурация ✅
- [x] Добавить инструкции для разработчиков ✅
- [x] Обновить документацию по разработке ✅

## Критерии приемки

✅ Тесты работают локально в Docker  
✅ Тесты работают в CI GitHub Actions  
✅ Нет дублирования конфигурации  
✅ Конфигурация понятна и документирована

## Технические детали

### Текущая конфигурация

**phpunit.xml** (локально):
```xml
<env name="DB_HOST" value="mysql"/>
<env name="DB_USERNAME" value="cooltodo"/>
<env name="DB_PASSWORD" value="root"/>
```

**CI workflow**:
```yaml
env:
  DB_HOST: 127.0.0.1
  DB_USERNAME: root
  DB_PASSWORD: root
```

### Ожидаемое решение

PHPUnit использует переменные окружения, если они установлены, иначе значения из `<env>` в `phpunit.xml`. Это означает, что текущая конфигурация должна работать, но нужно проверить и документировать.

## Прогресс

Создано: 2025-01-27  
Завершено: 2025-01-27

### Выполненные действия

1. **Анализ конфигурации PHPUnit** ✅
   - PHPUnit устанавливает переменные из `<env>` только если они не установлены в системе
   - Код: `if ($force || getenv($name) === false) { putenv(...); }`
   - Это означает, что переменные окружения из CI переопределяют значения из `phpunit.xml`

2. **Проверка работы конфигурации** ✅
   - Локально: использует значения из `phpunit.xml` (DB_HOST=mysql, DB_USERNAME=cooltodo)
   - В CI: переменные окружения переопределяют значения (DB_HOST=127.0.0.1, DB_USERNAME=root)
   - Тесты работают в обоих окружениях

3. **Улучшение конфигурации** ✅
   - Добавлены комментарии в `phpunit.xml` для ясности
   - Документировано, как работает конфигурация
   - Указано, что переменные окружения переопределяют значения по умолчанию

### Результаты

- ✅ Конфигурация работает локально в Docker
- ✅ Конфигурация работает в CI GitHub Actions
- ✅ Нет дублирования настроек
- ✅ Конфигурация документирована

## Заметки

- PHPUnit автоматически использует переменные окружения, если они установлены
- Значения из `<env>` в `phpunit.xml` используются как fallback для локальной разработки
- CI workflow устанавливает переменные окружения, которые переопределяют значения из `phpunit.xml`
- Конфигурация универсальна и работает в обоих окружениях без изменений

