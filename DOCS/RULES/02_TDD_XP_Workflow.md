# TDD и XP Workflow

## Миссия

Ты — автономный инженерный агент, практикующий Extreme Programming (XP) с полным Test-Driven Development (TDD). Твоя цель — создавать качественный, тестируемый код для проекта CoolTodo, следуя принципам XP и TDD.

## Руководящие принципы

### Outside-In Evolution

Начинай с высокоуровневого поведения, двигайся к деталям:

1. **Acceptance Test First**: Напиши acceptance-тест, описывающий поведение с точки зрения пользователя
2. **Integration Test**: Напиши интеграционный тест для API/компонента
3. **Unit Test**: Напиши юнит-тест для конкретной функции/класса
4. **Implementation**: Реализуй минимальный код для прохождения теста
5. **Refactor**: Улучши код, сохраняя тесты зелеными

### Always Green Main Branch

Каждый коммит должен проходить сборку, тесты, CI:

- ❌ **Запрещено**: Коммитить код, который не компилируется
- ❌ **Запрещено**: Коммитить код с failing тестами
- ✅ **Обязательно**: Все тесты должны быть зелеными перед коммитом
- ✅ **Обязательно**: CI пайплайн должен проходить успешно

### Test-First Mindset

Нет production кода без предшествующего failing теста:

1. **Red**: Напиши тест, который падает (описывает желаемое поведение)
2. **Green**: Напиши минимальный код, чтобы тест прошел
3. **Refactor**: Улучши код, сохраняя тесты зелеными

**Правило**: Если нет failing теста, не пиши production код.

### Incremental Learning

Уточняй архитектуру с помощью коротких циклов обратной связи:

- Начинай с простого решения
- Добавляй сложность только когда это необходимо
- Рефакторинг — постоянная часть процесса
- Используй feedback от тестов для улучшения дизайна

### Automated Delivery

Поддерживай CI/CD с самых ранних итераций:

- Каждый PR должен запускать полный набор тестов
- Автоматическая проверка качества кода (PHPStan, PHP-CS-Fixer)
- Автоматический деплой после успешного прохождения CI

## Обзор фаз разработки

### Фаза 1: Инициализация скелета

**Цель**: Создать базовую структуру проекта, готовую к разработке

**Шаги**:
1. Инициализировать репозиторий
2. Настроить CI пайплайн
3. Создать метаданные пакета (composer.json, package.json)
4. Настроить инструменты качества кода (PHPStan, PHP-CS-Fixer)
5. Создать базовую структуру директорий

**Критерии завершения**:
- ✅ Проект собирается успешно
- ✅ CI пайплайн запускается и проходит
- ✅ Инструменты качества кода настроены

### Фаза 2: Написание высокоуровневых acceptance-тестов

**Цель**: Определить поведение системы через тесты

**Шаги**:
1. Написать acceptance-тесты для ключевых пользовательских сценариев
2. Использовать Laravel Dusk для E2E тестов
3. Использовать Feature тесты для API endpoints

**Пример**:
```php
// tests/Feature/TodoTest.php
public function test_user_can_create_todo(): void
{
    $response = $this->postJson('/api/todos', [
        'title' => 'Test Todo',
        'status' => 'active'
    ]);
    
    $response->assertStatus(201)
        ->assertJson(['title' => 'Test Todo']);
}
```

**Критерии завершения**:
- ✅ Acceptance-тесты написаны для всех основных сценариев
- ✅ Тесты падают (Red) — код еще не реализован

### Фаза 3: Реализация Outside-In

**Цель**: Реализовать функциональность, начиная с внешнего слоя

**Шаги**:
1. Начать с контроллера/API endpoint
2. Реализовать Use Case (бизнес-логика)
3. Реализовать Repository (доступ к данным)
4. Реализовать Domain Model (сущности)

**Порядок реализации**:
```
Controller → Use Case → Repository → Domain Model
```

**Критерии завершения**:
- ✅ Acceptance-тесты проходят (Green)
- ✅ Все слои реализованы
- ✅ Код покрыт тестами

### Фаза 4: Цикл рефакторинга

**Цель**: Улучшить качество кода, сохраняя функциональность

**Шаги**:
1. Запустить статический анализ (PHPStan)
2. Исправить предупреждения
3. Применить форматирование (PHP-CS-Fixer)
4. Улучшить читаемость кода
5. Убедиться, что все тесты все еще зеленые

**Критерии завершения**:
- ✅ PHPStan level 9 без ошибок
- ✅ Код соответствует PSR-12
- ✅ Все тесты зеленые

### Фаза 5: Готовность к развертыванию

**Цель**: Подготовить код к production

**Шаги**:
1. Настроить Docker окружение
2. Настроить production конфигурацию
3. Оптимизировать производительность
4. Настроить мониторинг и логирование
5. Создать документацию

**Критерии завершения**:
- ✅ Приложение работает в Docker
- ✅ Производительность соответствует требованиям (100 RPS)
- ✅ Документация актуальна

## TDD Red-Green-Refactor цикл

### Red: Написать failing тест

```php
public function test_can_create_todo(): void
{
    $todo = new Todo('Test Task');
    $this->assertEquals('Test Task', $todo->getTitle());
}
```

**Результат**: Тест падает, потому что класс `Todo` не существует.

### Green: Написать минимальный код

```php
class Todo
{
    public function __construct(private string $title) {}
    
    public function getTitle(): string
    {
        return $this->title;
    }
}
```

**Результат**: Тест проходит.

### Refactor: Улучшить код

```php
class Todo
{
    public function __construct(
        private string $title,
        private string $status = 'active'
    ) {}
    
    public function getTitle(): string
    {
        return $this->title;
    }
    
    public function getStatus(): string
    {
        return $this->status;
    }
}
```

**Результат**: Код улучшен, тесты все еще зеленые.

## Правила работы с тестами

### Структура тестов

```
tests/
├── Unit/              # Юнит-тесты (бизнес-логика)
│   ├── Domain/
│   └── UseCases/
├── Feature/           # Интеграционные тесты (API)
│   └── Api/
└── Browser/           # E2E тесты (Laravel Dusk)
    └── TodoTest.php
```

### Покрытие тестами

- **Domain Layer**: >90% покрытие юнит-тестами
- **API Endpoints**: 100% покрытие интеграционными тестами
- **User Journeys**: Все ключевые сценарии покрыты E2E тестами

### Моки и стабы

- Используй моки для изоляции бизнес-логики от инфраструктуры
- Используй стабы для внешних сервисов (API, БД)
- Избегай моков в интеграционных тестах (используй реальную БД)

## Контрольный список перед коммитом

- [ ] Все тесты проходят (green)
- [ ] PHPStan level 9 без ошибок
- [ ] PHP-CS-Fixer применен
- [ ] Код соответствует PSR-12
- [ ] CI пайплайн проходит
- [ ] Документация обновлена (если нужно)







