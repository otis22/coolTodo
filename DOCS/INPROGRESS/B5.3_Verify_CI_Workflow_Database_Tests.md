# Task B5.3: Проверить и исправить CI workflow для тестов с БД

**Статус**: In Progress  
**Начало**: 2025-01-27  
**Приоритет**: High  
**Оценка**: 0.25 дня

## Описание

Проверить, что тесты с БД работают корректно в CI workflow после изменений в B5.1 и B5.2. Исправить любые проблемы, если они обнаружены.

## Проблемы для проверки

### Потенциальная проблема 1: Неполные переменные окружения в CI

**Текущая конфигурация в workflow**:
```yaml
env:
  DB_HOST: 127.0.0.1
  DB_DATABASE: cooltodo_test
  DB_USERNAME: root
  DB_PASSWORD: root
```

**Отсутствуют**:
- `DB_PORT: 3306`
- `DB_CONNECTION: mysql`

**В phpunit.xml есть**:
- `DB_CONNECTION: mysql`
- `DB_PORT: 3306`

**Проблема**: Хотя PHPUnit использует значения из `phpunit.xml` как fallback, лучше явно указать все переменные в CI для ясности и избежания потенциальных проблем.

### Потенциальная проблема 2: Миграции в CI

В шаге "Run database migrations" также отсутствуют `DB_PORT` и `DB_CONNECTION`.

## Зависимости

- [x] B5.1: Исправить окружение БД для feature тестов (Completed ✅)
- [x] B5.2: Универсальная конфигурация БД для тестов (Completed ✅)

## План выполнения

### Шаг 1: Проверка результатов CI
- [ ] Проверить результаты последнего workflow run
- [ ] Убедиться, что тесты с БД проходят
- [ ] Проверить логи на наличие ошибок подключения к БД

### Шаг 2: Исправление конфигурации (если необходимо)
- [x] Добавить недостающие переменные окружения в workflow ✅
- [x] Убедиться, что все переменные соответствуют настройкам MySQL сервиса ✅
- [ ] Проверить, что миграции выполняются корректно (требуется проверка в CI)

### Шаг 3: Проверка после исправлений
- [ ] Запустить workflow и проверить результаты
- [ ] Убедиться, что все тесты проходят

## Критерии приемки

✅ Тесты с БД проходят в CI workflow  
✅ Все переменные окружения явно указаны  
✅ Нет ошибок подключения к БД  
✅ Миграции выполняются корректно

## Технические детали

### Текущая конфигурация MySQL сервиса в CI

```yaml
services:
  mysql:
    image: mysql:8.0
    env:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cooltodo_test
    ports:
      - 3306:3306
```

### Рекомендуемые переменные окружения для тестов

```yaml
env:
  DB_CONNECTION: mysql
  DB_HOST: 127.0.0.1
  DB_PORT: 3306
  DB_DATABASE: cooltodo_test
  DB_USERNAME: root
  DB_PASSWORD: root
```

## Прогресс

Создано: 2025-01-27

### Выполненные действия

1. **Добавлены недостающие переменные окружения** ✅
   - Добавлен `DB_CONNECTION: mysql` в шаг "Run PHPUnit tests"
   - Добавлен `DB_PORT: 3306` в шаг "Run PHPUnit tests"
   - Добавлены те же переменные в шаг "Run database migrations"

2. **Обновлен workflow** ✅
   - Все переменные окружения теперь явно указаны
   - Конфигурация соответствует настройкам MySQL сервиса

### Обнаруженные проблемы

1. **Отсутствует `continue-on-error: true` в шаге Upload coverage** ✅ Исправлено
   - Если coverage.xml не найден, workflow упадет
   - Добавлен `continue-on-error: true` для этого шага

### Требуется проверка

- [ ] Проверить результаты CI workflow после следующего push
- [ ] Убедиться, что тесты с БД проходят
- [ ] Проверить логи на наличие ошибок
- [ ] Убедиться, что coverage.xml генерируется в правильном месте

## Заметки

- Переменные окружения добавлены для ясности и избежания потенциальных проблем
- После проверки результатов CI можно будет закрыть задачу

