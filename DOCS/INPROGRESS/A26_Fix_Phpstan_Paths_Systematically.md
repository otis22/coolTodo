# Task A26: Исправить пути PHPStan системно (без поломки CI)

**Статус**: Open  
**Приоритет**: High  
**Оценка**: 0.5 дня

## Описание

Текущее решение с `phpstan.docker.neon` работает локально, но создает дублирование конфигурации и может привести к рассинхронизации между локальной и CI конфигурациями. Нужно найти системное решение, которое будет работать и локально (Docker), и в CI без дублирования конфигурации.

## Проблема

**Текущая ситуация**:
- `phpstan.neon` в корне проекта с путями `backend/src`, `tests` (для CI)
- `phpstan.docker.neon` в `backend/` с путями `src`, `../tests` (для Docker)
- Дублирование конфигурации
- Риск рассинхронизации между конфигурациями

**Проблема с путями**:
- В CI: PHPStan запускается из `working-directory: backend` с `--configuration=../phpstan.neon`
  - Конфигурация находится в корне проекта
  - Пути в конфигурации разрешаются относительно расположения файла конфигурации (корень проекта)
  - `backend/src` → `/home/runner/work/coolTodo/coolTodo/backend/src` ✅
  - `tests` → `/home/runner/work/coolTodo/coolTodo/tests` ✅
  
- В Docker: PHPStan запускается из `/var/www/html` (backend/) с `--configuration=../phpstan.neon`
  - Конфигурация находится в корне проекта (монтирована как `/var/www/html/../phpstan.neon`)
  - Пути в конфигурации разрешаются относительно расположения файла конфигурации (корень проекта)
  - `backend/src` → `/var/www/html/../backend/src` = `/var/www/backend/src` ❌ (не существует)
  - `tests` → `/var/www/html/../tests` = `/var/www/tests` ❌ (не существует, tests в корне проекта)
  - Нужны пути относительно корня проекта, но структура в Docker другая

## Решение

**Вариант 1 (Рекомендуемый)**: Использовать одну конфигурацию с условными путями

Создать `phpstan.neon` который работает в обоих случаях:
- Использовать переменные окружения или проверку существования путей
- Или использовать относительные пути, которые работают в обоих случаях

**Вариант 2**: Использовать PHPStan bootstrap для определения путей

Создать bootstrap скрипт, который определяет окружение и настраивает пути динамически.

**Вариант 3**: Использовать параметры командной строки для переопределения путей

Передавать пути через параметры командной строки в скрипте `dev`:
```bash
phpstan)
    shift
    exec_tools phpstan analyse --configuration=../phpstan.neon --paths=src --paths=../tests "$@"
    ;;
```

**Вариант 3.1**: Использовать переменные окружения в конфигурации

PHPStan поддерживает переменные окружения в конфигурации через `%env.VAR_NAME%`. Можно создать переменную окружения, которая определяет базовый путь.

**Вариант 3.2**: Использовать абсолютные пути в конфигурации

Определить абсолютный путь к корню проекта и использовать его в конфигурации.

**Вариант 4**: Использовать includes с условной логикой

Создать базовую конфигурацию и включать специфичные для окружения части.

## Критерии приемки

✅ Одна конфигурация `phpstan.neon` работает и в CI, и локально  
✅ Нет дублирования конфигурации  
✅ PHPStan анализирует все файлы в обоих окружениях  
✅ CI workflow не сломан  
✅ Локальное окружение работает корректно

## Зависимости

- [x] A21: Исправить путь к larastan extension.neon в phpstan.neon (Completed ✅)
- [x] A25: Исправить пути к конфигурационным файлам в скрипте dev (Completed ✅)
- [ ] A24: Исправить пути в конфигурации PHPStan (Blocked - временное решение создает дублирование)

## Связанные задачи

- A24: Исправить пути в конфигурации PHPStan (Blocked - требует системного решения)
- A25: Исправить пути к конфигурационным файлам в скрипте dev (Completed ✅)
- A27: Исправить пути конфигурации PHP-CS-Fixer для Docker (аналогичная проблема)
- A28: Унифицировать пути конфигураций инструментов системно (системное решение для всех инструментов)

## Примечания

Текущее решение с `phpstan.docker.neon` работает, но не является оптимальным из-за дублирования. Эта задача должна найти системное решение без дублирования конфигурации.

