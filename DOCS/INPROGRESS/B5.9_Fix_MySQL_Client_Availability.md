# Task B5.9: Исправить доступность MySQL client в CI

**Статус**: In Progress  
**Начало**: 2025-01-27  
**Приоритет**: Medium  
**Оценка**: 0.25 дня

## Описание

Исправить потенциальную проблему с доступностью `mysqladmin` команды в Ubuntu runner. MySQL client может быть не установлен по умолчанию.

## Проблема

### Текущая ситуация

**Шаг "Wait for MySQL"**:
```yaml
- name: Wait for MySQL
  run: |
    for i in {1..30}; do
      if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent 2>/dev/null; then
        echo "MySQL is ready!"
        break
      fi
      echo "Waiting for MySQL... ($i/30)"
      sleep 2
    done
```

**Проблема**:
- `mysqladmin` может быть недоступен в Ubuntu runner по умолчанию
- MySQL client не установлен автоматически в GitHub Actions
- Это может привести к ошибке "command not found"

**Симптомы**:
- Workflow падает с ошибкой "mysqladmin: command not found"
- Проверка готовности MySQL не работает
- Миграции могут запуститься до готовности MySQL

## Зависимости

- [x] B5.7: Добавить проверку готовности MySQL перед миграциями (Completed ✅)

## Требования

### Цель

Обеспечить доступность MySQL client в CI:
- Установить MySQL client перед проверкой готовности
- Или использовать альтернативный способ проверки
- Сделать проверку надежной

### Решения

**Вариант 1 (Рекомендуемый)**: Установить MySQL client
```yaml
- name: Install MySQL client
  run: sudo apt-get update && sudo apt-get install -y default-mysql-client

- name: Wait for MySQL
  run: |
    for i in {1..30}; do
      if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent 2>/dev/null; then
        echo "MySQL is ready!"
        break
      fi
      echo "Waiting for MySQL... ($i/30)"
      sleep 2
    done
```

**Вариант 2**: Использовать альтернативную проверку через PHP
```yaml
- name: Wait for MySQL
  working-directory: backend
  run: |
    for i in {1..30}; do
      if php -r "try { new PDO('mysql:host=127.0.0.1;port=3306', 'root', 'root'); echo 'MySQL is ready!'; exit(0); } catch (Exception \$e) { exit(1); }" 2>/dev/null; then
        break
      fi
      echo "Waiting for MySQL... ($i/30)"
      sleep 2
    done
```

**Вариант 3**: Использовать готовый action
- Использовать специализированный action для ожидания сервисов
- Например: `jakejarvis/wait-action` или `dockerize`

## План выполнения

### Шаг 1: Проверка проблемы
- [x] Проверить, доступен ли mysqladmin в Ubuntu runner ✅
- [x] Определить оптимальное решение ✅ (использовать PHP PDO)
- [x] Проверить влияние на время выполнения ✅

### Шаг 2: Реализация
- [x] Установить MySQL client или использовать альтернативу ✅ (используем PHP)
- [x] Обновить шаг "Wait for MySQL" ✅
- [ ] Протестировать в CI

## Критерии приемки

✅ MySQL client доступен в CI  
✅ Проверка готовности MySQL работает корректно  
✅ Workflow не замедляется значительно  
✅ Нет ошибок "command not found"

## Технические детали

### Текущая конфигурация

Используется `mysqladmin` без проверки доступности.

### Рекомендуемое решение

Установить MySQL client перед проверкой:
```yaml
- name: Install MySQL client
  run: |
    sudo apt-get update
    sudo apt-get install -y default-mysql-client

- name: Wait for MySQL
  run: |
    for i in {1..30}; do
      if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent 2>/dev/null; then
        echo "MySQL is ready!"
        break
      fi
      echo "Waiting for MySQL... ($i/30)"
      sleep 2
    done
  timeout-minutes: 2
```

Или использовать PHP для проверки (уже установлен):
```yaml
- name: Wait for MySQL
  working-directory: backend
  run: |
    for i in {1..30}; do
      if php -r "\$pdo = new PDO('mysql:host=127.0.0.1;port=3306', 'root', 'root'); echo 'MySQL is ready!';" 2>/dev/null; then
        break
      fi
      echo "Waiting for MySQL... ($i/30)"
      sleep 2
    done
  timeout-minutes: 2
```

## Прогресс

Создано: 2025-01-27

## Заметки

- MySQL client может быть недоступен в Ubuntu runner по умолчанию
- PHP уже установлен, можно использовать для проверки
- Альтернатива через PHP не требует дополнительных зависимостей

