# Task B5.8: Исправить генерацию coverage при падении тестов

**Статус**: In Progress  
**Начало**: 2025-01-27  
**Приоритет**: Low  
**Оценка**: 0.25 дня

## Описание

Исправить проблему, когда coverage.xml не генерируется, если тесты падают. Текущая конфигурация может не создавать coverage.xml при ошибках тестов.

## Проблема

### Текущая ситуация

**Шаг "Run PHPUnit tests"**:
```yaml
- name: Run PHPUnit tests
  working-directory: backend
  run: vendor/bin/phpunit --configuration=../phpunit.xml --coverage-text --coverage-clover=../coverage.xml
  continue-on-error: true
```

**Проблема**:
- Если тесты падают, PHPUnit может не создать coverage.xml
- Шаг "Upload coverage to Codecov" может падать, даже с continue-on-error
- Coverage не загружается в Codecov при ошибках тестов

**Симптомы**:
- Coverage.xml отсутствует после падения тестов
- Codecov не получает данные о покрытии
- Сложно отследить покрытие кода при ошибках

## Зависимости

- [x] B5.4: Системное решение для coverage.xml (Completed ✅)
- [x] B5.6: Улучшить обработку ошибок в CI workflow (если выполняется)

## Требования

### Цель

Обеспечить генерацию coverage.xml даже при падении тестов:
- Coverage должен генерироваться независимо от результата тестов
- Codecov должен получать данные даже при ошибках
- Не должно влиять на основной workflow

### Решения

**Вариант 1 (Рекомендуемый)**: Разделить на два шага
- Шаг 1: Запустить тесты без coverage
- Шаг 2: Запустить тесты с coverage (если первый успешен)
- Или использовать `--coverage-clover` всегда, но обрабатывать отсутствие файла

**Вариант 2**: Использовать условие для проверки файла
```yaml
- name: Upload coverage to Codecov
  if: always() && fileExists('./coverage.xml')
  uses: codecov/codecov-action@v3
  ...
```

**Вариант 3**: Генерировать coverage отдельно
- Запускать тесты дважды: один раз для проверки, второй для coverage
- Но это увеличивает время выполнения

## План выполнения

### Шаг 1: Анализ проблемы
- [x] Проверить, генерируется ли coverage.xml при падении тестов ✅
- [x] Определить оптимальное решение ✅
- [x] Проверить влияние на время выполнения ✅

### Шаг 2: Реализация
- [x] Обновить workflow для надежной генерации coverage ✅
- [x] Добавить проверку существования файла перед загрузкой ✅
- [ ] Протестировать различные сценарии

## Критерии приемки

✅ Coverage.xml генерируется даже при падении тестов (если возможно)  
✅ Codecov получает данные о покрытии  
✅ Workflow не замедляется значительно  
✅ Обработка ошибок корректна

## Технические детали

### Текущая конфигурация

Coverage генерируется в том же шаге, что и тесты. Если тесты падают, coverage может не создаться.

### Рекомендуемое решение

1. **Использовать условие для проверки файла**:
```yaml
- name: Upload coverage to Codecov
  if: always() && hashFiles('coverage.xml') != ''
  uses: codecov/codecov-action@v3
  ...
```

2. **Или разделить на два шага**:
```yaml
- name: Run PHPUnit tests
  run: vendor/bin/phpunit --configuration=../phpunit.xml

- name: Generate coverage
  if: success() || failure()
  run: vendor/bin/phpunit --configuration=../phpunit.xml --coverage-clover=../coverage.xml
  continue-on-error: true
```

## Прогресс

Создано: 2025-01-27

## Заметки

- PHPUnit может не генерировать coverage при критических ошибках
- Нужно найти баланс между надежностью и производительностью
- Coverage при ошибках может быть полезен для отладки

