# Task A28: Унифицировать пути конфигураций инструментов системно

**Статус**: Completed ✅  
**Приоритет**: High  
**Оценка**: 1 день

## Описание

Все инструменты качества кода (PHPUnit, PHPStan, PHP-CS-Fixer) имеют проблему с путями в конфигурационных файлах при работе в разных окружениях (CI и Docker). Нужно создать системное решение для унификации путей, которое будет работать и в CI, и локально без дублирования конфигураций.

## Проблема

**Текущая ситуация**:

1. **PHPUnit** (`phpunit.xml`):
   - CI: `--configuration=../phpunit.xml` из `working-directory: backend`
   - Локально: `--configuration=../phpunit.xml` из `/var/www/html`
   - Пути в конфигурации: `backend/vendor/autoload.php`, `backend/src`, `tests/Unit`
   - Проблема: Пути разрешаются относительно расположения конфигурационного файла (корень проекта), что работает в обоих случаях ✅

2. **PHPStan** (`phpstan.neon`):
   - CI: `--configuration=../phpstan.neon` из `working-directory: backend`
   - Локально: `--configuration=../phpstan.neon` из `/var/www/html`
   - Пути в конфигурации: `backend/src`, `tests`
   - Проблема: Пути не работают в Docker контейнере (A24, A26)

3. **PHP-CS-Fixer** (`.php-cs-fixer.php`):
   - CI: `--config=../.php-cs-fixer.php` из `working-directory: backend`
   - Локально: конфигурация не указана
   - Пути в конфигурации: `__DIR__ . '/backend/src'`, `__DIR__ . '/tests'`
   - Проблема: Конфигурация не монтируется, пути не работают в Docker (A27)

**Корневая причина**:
- В CI все инструменты запускаются из `working-directory: backend` с конфигурациями из корня проекта
- В Docker контейнерах монтируется только `./backend` в `/var/www/html`
- Конфигурационные файлы находятся в корне проекта и монтируются отдельно
- Пути в конфигурациях разрешаются относительно расположения файла конфигурации (корень проекта)
- Но структура директорий в Docker отличается: нет `backend/` внутри `/var/www/html`

## Решение

**Вариант 1 (Рекомендуемый)**: Унифицировать структуру через условные пути

Создать единый подход для всех конфигураций:
- Использовать проверку существования путей
- Или использовать переменные окружения для определения базового пути
- Или использовать относительные пути, которые работают в обоих случаях

**Вариант 2**: Унифицировать структуру Docker

Изменить монтирование в `docker-compose.yml`:
- Монтировать корень проекта в `/var/www/project`
- Монтировать `./backend` в `/var/www/project/backend`
- Обновить `working_dir` на `/var/www/project/backend`
- Все пути в конфигурациях будут работать одинаково

**Вариант 3**: Использовать параметры командной строки

Передавать пути через параметры командной строки в скрипте `dev` для всех инструментов.

**Вариант 4**: Создать wrapper скрипты

Создать скрипты-обертки, которые определяют окружение и настраивают пути динамически.

## Критерии приемки

✅ Все инструменты (PHPUnit, PHPStan, PHP-CS-Fixer) работают с одной конфигурацией  
✅ Нет дублирования конфигураций  
✅ Конфигурации работают и в CI, и локально  
✅ CI workflow не сломан  
✅ Локальное окружение работает корректно  
✅ Единый подход для всех инструментов

## Зависимости

- [x] A17: Исправить пути в CI для PHPUnit (Completed ✅)
- [x] A21: Исправить путь к larastan extension.neon в phpstan.neon (Completed ✅)
- [x] A25: Исправить пути к конфигурационным файлам в скрипте dev (Completed ✅)
- [ ] A26: Исправить пути PHPStan системно (связано)
- [ ] A27: Исправить пути конфигурации PHP-CS-Fixer для Docker (связано)

## Связанные задачи

- A24: Исправить пути в конфигурации PHPStan (Blocked - требует системного решения)
- A26: Исправить пути PHPStan системно (часть системного решения)
- A27: Исправить пути конфигурации PHP-CS-Fixer для Docker (часть системного решения)
- A22: Исправить форматирование кода PHP-CS-Fixer (блокируется отсутствием конфигурации)

## Реализация

### Выбранное решение: Вариант 2 - Унифицировать структуру Docker

**Изменения в `docker-compose.yml`**:
- Монтирование корня проекта: `.:/var/www/project:cached`
- Монтирование `./backend` в `/var/www/project/backend` (через общее монтирование корня)
- Обновлен `working_dir` на `/var/www/project/backend` для контейнеров `app` и `tools`
- Удалены отдельные монтирования конфигурационных файлов (теперь доступны через корень проекта)

**Изменения в `dev` скрипте**:
- PHP-CS-Fixer: добавлен `--config=../.php-cs-fixer.php`

**Исправления конфигураций**:
- `phpstan.neon`: удален устаревший параметр `checkMissingIterableValueType`
- `phpstan.neon`: удален неиспользуемый паттерн `ignoreErrors`

### Результаты проверки

✅ **PHPUnit**:
- Работает корректно: `13 tests, 32 assertions`
- Конфигурация `phpunit.xml` работает в обоих окружениях
- Пути `backend/src` и `tests/Unit` разрешаются правильно

✅ **PHPStan**:
- Работает корректно: `[OK] No errors`
- Конфигурация `phpstan.neon` работает в обоих окружениях
- Пути `backend/src` и `tests` разрешаются правильно

✅ **PHP-CS-Fixer**:
- Работает корректно: находит 13 файлов для исправления
- Конфигурация `.php-cs-fixer.php` работает в обоих окружениях
- Пути `__DIR__ . '/backend/src'` и `__DIR__ . '/tests'` разрешаются правильно

✅ **CI Workflow совместимость**:
- Все команды в CI используют `working-directory: backend` с `--configuration=../...`
- Структура теперь идентична: в CI и Docker оба работают из `backend/` с конфигурациями из корня
- Пути в конфигурациях разрешаются относительно расположения файла (корень проекта)
- CI workflow не требует изменений

### Проблемы и решения

**Проблема 1**: PHPStan выдавал ошибку о неожиданном параметре `checkMissingIterableValueType`
- **Решение**: Удален устаревший параметр из `phpstan.neon`

**Проблема 2**: PHPStan выдавал предупреждение о неиспользуемом паттерне `#PHPDoc tag @var#`
- **Решение**: Удален неиспользуемый паттерн из `ignoreErrors`

**Проблема 3**: PHPUnit не находил тесты при указании относительного пути
- **Решение**: Используется конфигурация `--configuration=../phpunit.xml`, которая правильно определяет пути

### Созданные/обновленные файлы

- ✅ `docker-compose.yml` - изменена структура монтирования
- ✅ `dev` - добавлен `--config` для PHP-CS-Fixer
- ✅ `phpstan.neon` - удалены устаревшие параметры

## Примечания

Эта задача решена системно для всех инструментов сразу, что обеспечило единообразие и отсутствие дублирования конфигураций. Структура Docker теперь идентична структуре CI, что гарантирует совместимость.

