# Task B5.6: Улучшить обработку ошибок в CI workflow

**Статус**: Completed ✅  
**Начало**: 2025-01-27  
**Завершено**: 2025-01-27  
**Приоритет**: Medium  
**Оценка**: 0.5 дня

## Описание

Улучшить обработку ошибок в CI workflow. Текущая конфигурация использует `continue-on-error: true` для всех шагов, что может скрывать реальные проблемы.

## Проблема

### Проблема 1: Все шаги имеют continue-on-error: true

**Текущая ситуация**:
- Все шаги (миграции, тесты, PHPStan, PHP-CS-Fixer) имеют `continue-on-error: true`
- Это означает, что workflow всегда завершается успешно, даже если есть ошибки
- Реальные проблемы могут быть скрыты

**Проблемы**:
- Критические ошибки (падение тестов) не останавливают workflow
- Сложно понять, какие шаги реально провалились
- Coverage может не генерироваться, если тесты падают, но workflow продолжается

### Проблема 2: Нет проверки готовности MySQL сервиса

**Текущая ситуация**:
- MySQL сервис имеет health check, но нет явной проверки перед запуском миграций
- Миграции могут запуститься до того, как MySQL полностью готов

**Проблемы**:
- Потенциальные race conditions
- Миграции могут падать из-за недоступности БД

### Проблема 3: Нет явной проверки успешности критических шагов

**Текущая ситуация**:
- Нет явной проверки, что миграции выполнились успешно
- Нет явной проверки, что тесты прошли
- Workflow может завершиться "успешно", даже если тесты упали

## Зависимости

- [x] B5.3: Проверить и исправить CI workflow для тестов с БД (In Progress)

## Требования

### Цель

Создать более надежную конфигурацию workflow:
- Критические шаги (тесты, миграции) должны останавливать workflow при ошибках
- Некритические шаги (PHP-CS-Fixer, coverage upload) могут иметь continue-on-error
- Добавить явные проверки готовности сервисов

### Решения

**Вариант 1 (Рекомендуемый)**: Разделить шаги на критические и некритические
- Критические (без continue-on-error): миграции, тесты
- Некритические (с continue-on-error): PHP-CS-Fixer, PHPStan, coverage upload, frontend build

**Вариант 2**: Использовать условия для проверки успешности
- Добавить шаги проверки после критических операций
- Использовать `if: success()` для условного выполнения

**Вариант 3**: Использовать job dependencies
- Разделить на несколько jobs
- Критические шаги в отдельном job без continue-on-error

## План выполнения

### Шаг 1: Анализ текущей конфигурации
- [x] Определить критические шаги ✅
- [x] Определить некритические шаги ✅
- [x] Проверить зависимости между шагами ✅

### Шаг 2: Обновление workflow
- [x] Убрать `continue-on-error: true` из критических шагов ✅
- [x] Оставить `continue-on-error: true` для некритических шагов ✅
- [ ] Добавить проверку готовности MySQL перед миграциями (B5.7)

### Шаг 3: Тестирование
- [ ] Проверить, что workflow останавливается при ошибках тестов
- [ ] Проверить, что workflow продолжается при ошибках PHP-CS-Fixer
- [ ] Убедиться, что все работает корректно

## Критерии приемки

✅ Критические шаги останавливают workflow при ошибках  
✅ Некритические шаги не останавливают workflow  
✅ MySQL проверяется на готовность перед миграциями  
✅ Workflow статус корректно отражает реальное состояние

## Технические детали

### Критические шаги (без continue-on-error)

- Run database migrations
- Run PHPUnit tests

### Некритические шаги (с continue-on-error)

- Run PHP-CS-Fixer (форматирование можно исправить позже)
- Run PHPStan (анализ можно исправить позже)
- Build frontend (не критично для бэкенда)
- Upload coverage to Codecov (опционально)

### Проверка готовности MySQL

```yaml
- name: Wait for MySQL
  run: |
    until mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; do
      echo "Waiting for MySQL..."
      sleep 2
    done
```

## Прогресс

Создано: 2025-01-27

## Заметки

- continue-on-error: true полезен для некритических шагов, но скрывает проблемы в критических
- Нужно найти баланс между надежностью и гибкостью
- Можно использовать matrix strategy для разделения на критические и некритические шаги

