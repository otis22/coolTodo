# Task B5.7: Добавить проверку готовности MySQL перед миграциями

**Статус**: In Progress  
**Начало**: 2025-01-27  
**Приоритет**: Medium  
**Оценка**: 0.25 дня

## Описание

Добавить явную проверку готовности MySQL сервиса перед запуском миграций в CI workflow для предотвращения race conditions.

## Проблема

### Текущая ситуация

**MySQL сервис**:
```yaml
services:
  mysql:
    image: mysql:8.0
    options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
```

**Проблема**:
- Health check настроен, но нет явной проверки перед запуском миграций
- Миграции могут запуститься до того, как MySQL полностью готов к работе
- Это может приводить к случайным ошибкам подключения

**Симптомы**:
- Иногда миграции падают с ошибкой подключения
- Ошибки нестабильны (иногда работают, иногда нет)
- Сложно воспроизвести проблему локально

## Зависимости

- [x] B5.3: Проверить и исправить CI workflow для тестов с БД (In Progress)

## Требования

### Цель

Добавить явную проверку готовности MySQL перед запуском миграций:
- Убедиться, что MySQL полностью готов
- Предотвратить race conditions
- Сделать workflow более надежным

### Решения

**Вариант 1 (Рекомендуемый)**: Добавить шаг проверки перед миграциями
```yaml
- name: Wait for MySQL
  run: |
    until mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; do
      echo "Waiting for MySQL..."
      sleep 2
    done
    echo "MySQL is ready!"
```

**Вариант 2**: Использовать готовый action
- Использовать action для ожидания сервисов
- Например: `dockerize` или специализированный action

**Вариант 3**: Увеличить health check retries
- Увеличить количество попыток health check
- Но это не гарантирует готовность перед миграциями

## План выполнения

### Шаг 1: Добавить проверку готовности
- [x] Добавить шаг "Wait for MySQL" перед миграциями ✅
- [ ] Проверить, что проверка работает корректно
- [ ] Убедиться, что это не замедляет workflow значительно

### Шаг 2: Тестирование
- [ ] Проверить, что миграции запускаются после готовности MySQL
- [ ] Убедиться, что нет ошибок подключения
- [ ] Проверить время выполнения workflow

## Критерии приемки

✅ MySQL проверяется на готовность перед миграциями  
✅ Нет ошибок подключения к БД  
✅ Workflow работает стабильно  
✅ Время выполнения не увеличилось значительно

## Технические детали

### Текущая конфигурация

MySQL сервис имеет health check, но нет явной проверки перед использованием.

### Рекомендуемое решение

Добавить шаг перед "Run database migrations":
```yaml
- name: Wait for MySQL
  run: |
    until mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; do
      echo "Waiting for MySQL..."
      sleep 2
    done
    echo "MySQL is ready!"
  timeout-minutes: 2
```

Или использовать более простую проверку:
```yaml
- name: Wait for MySQL
  run: |
    for i in {1..30}; do
      if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; then
        echo "MySQL is ready!"
        break
      fi
      echo "Waiting for MySQL... ($i/30)"
      sleep 2
    done
```

## Прогресс

Создано: 2025-01-27

## Заметки

- Health check в Docker Compose не гарантирует готовность перед запуском шагов
- Явная проверка делает workflow более надежным
- Timeout предотвращает бесконечное ожидание

