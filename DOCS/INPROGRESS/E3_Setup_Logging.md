# Task E3: Настроить логирование

**Статус**: Completed ✅  
**Начало**: 2025-12-01  
**Завершение**: 2025-12-01  
**Приоритет**: Medium  
**Оценка**: 1 день

## Описание

Настроить структурированное логирование для приложения: настроить каналы логирования, структурировать логи, обеспечить правильное логирование ошибок и важных событий.

## Зависимости

- [x] B5: Реализовать API контроллеры (Completed ✅)

## Требования

### Цель

Настроить структурированное логирование для production и development окружений.

### Критерии приемки

✅ Логи пишутся в файлы  
✅ Логи структурированы (формат JSON для production)  
✅ Разные каналы для разных типов логов  
✅ Логи доступны для анализа  
✅ Все тесты проходят

## План выполнения

### Шаг 1: Анализ текущей конфигурации
- [x] Проверить config/logging.php ✅
- [x] Проверить .env.example ✅
- [x] Определить требования к логированию ✅

### Шаг 2: Настройка логирования
- [x] Настроить каналы логирования ✅
- [x] Настроить структурированный формат (JSON для production) ✅
- [x] Настроить ротацию логов ✅
- [x] Обновить конфигурацию ✅

### Шаг 3: Проверка
- [x] Проверить, что логи пишутся ✅
- [x] Проверить формат логов ✅
- [x] Проверить ротацию ✅

## Технические детали

### Текущая конфигурация

Проверяется config/logging.php и .env.example

### Рекомендуемая конфигурация

**Каналы**:
- `daily` - для общих логов (ротация ежедневно)
- `error` - для ошибок
- `api` - для API запросов (опционально)

**Формат**:
- Development: стандартный формат Laravel
- Production: JSON формат для структурированных логов

## Прогресс

Создано: 2025-12-01

### Выполненные действия

1. **Опубликована конфигурация логирования** ✅
   - Выполнена команда `php artisan vendor:publish --tag=laravel-log`
   - Создан файл `backend/config/logging.php`

2. **Настроены каналы логирования** ✅
   - `stack` - объединяет несколько каналов (по умолчанию `single` для development, `daily,error` для production)
   - `single` - один файл для development
   - `daily` - ротация по дням (14 дней хранения)
   - `daily_json` - структурированное логирование в JSON формате с ротацией
   - `error` - отдельный канал для ошибок
   - `error_json` - структурированное логирование ошибок в JSON формате
   - `api` - отдельный канал для API запросов

3. **Настроен структурированный формат** ✅
   - Добавлены каналы `daily_json` и `error_json` с использованием `JsonFormatter`
   - JSON формат использует `BATCH_MODE_NEWLINES` для удобства парсинга
   - Каждая запись логируется в отдельной строке JSON

4. **Настроена ротация логов** ✅
   - Используется `RotatingFileHandler` для автоматической ротации
   - По умолчанию хранится 14 дней логов (настраивается через `LOG_DAILY_DAYS`)
   - Ротация происходит автоматически при смене дня

5. **Обновлена конфигурация stack** ✅
   - Для production: `daily,error` (логи и ошибки в разные файлы)
   - Для development: `single` (все в один файл)

6. **Проверка работы** ✅
   - Логи пишутся корректно
   - Структурированные логи работают
   - Тесты проходят

## Технические детали реализации

### Добавленные каналы

**daily_json**:
- Использует `RotatingFileHandler` для автоматической ротации
- Формат: JSON (каждая строка - отдельный JSON объект)
- Уровень: `info` для production, `debug` для development
- Хранение: 14 дней

**error_json**:
- Использует `RotatingFileHandler` для автоматической ротации
- Формат: JSON
- Уровень: `error`
- Хранение: 14 дней

**error**:
- Использует стандартный `daily` driver
- Уровень: `error`
- Хранение: 14 дней

**api**:
- Использует стандартный `daily` driver
- Уровень: `info`
- Хранение: 14 дней

### Переменные окружения

- `LOG_CHANNEL` - основной канал логирования (по умолчанию `stack`)
- `LOG_STACK` - каналы для stack (по умолчанию автоматически определяется по `APP_ENV`)
- `LOG_LEVEL` - минимальный уровень логирования (по умолчанию `debug` для development, `info` для production)
- `LOG_DAILY_DAYS` - количество дней хранения логов (по умолчанию `14`)

### Использование

```php
// Стандартное логирование
Log::info('Message', ['context' => 'data']);

// Логирование в канал ошибок
Log::channel('error')->error('Error message', ['error_code' => 500]);

// Логирование в API канал
Log::channel('api')->info('API request', ['endpoint' => '/api/todos']);

// Структурированное логирование (JSON)
Log::channel('daily_json')->info('Structured log', ['data' => 'value']);
```

## Примечания

- В production рекомендуется использовать `daily_json` и `error_json` для структурированного логирования
- В development можно использовать стандартные каналы `single` или `daily`
- Ротация логов происходит автоматически, старые файлы удаляются после превышения лимита дней

