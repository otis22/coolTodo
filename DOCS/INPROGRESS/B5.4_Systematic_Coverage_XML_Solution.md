# Task B5.4: Системное решение для coverage.xml в локальном и CI окружении

**Статус**: Open  
**Приоритет**: High  
**Оценка**: 0.5 дня

## Описание

Создать универсальное решение для генерации coverage.xml, которое работает и локально (Docker), и в CI (GitHub Actions) без конфликтов.

## Проблема

### Проблема 1: Coverage.xml не генерируется локально

**Симптомы**:
- При запуске `./dev phpunit --coverage-clover=coverage.xml` выдается предупреждение:
  ```
  XDEBUG_MODE=coverage (environment variable) or xdebug.mode=coverage (PHP configuration setting) has to be set
  ```
- Файл `coverage.xml` не создается

**Причина**:
- Xdebug не настроен для режима coverage в Docker контейнере
- Переменная окружения `XDEBUG_MODE=coverage` не установлена

### Проблема 2: Разные пути в локальном и CI окружении

**В CI workflow**:
```yaml
run: vendor/bin/phpunit --configuration=../phpunit.xml --coverage-text --coverage-clover=../coverage.xml
working-directory: backend
```
- Файл создается в корне проекта (относительно backend/)
- Путь: `./coverage.xml` в корне проекта

**Локально**:
- Команда запускается из корня проекта
- Нужен путь: `coverage.xml` в корне проекта

**Проблема**: Разные рабочие директории могут привести к путанице

## Зависимости

- [x] B5.3: Проверить и исправить CI workflow для тестов с БД (In Progress)

## Требования

### Цель

Создать единое решение, которое:
- Генерирует `coverage.xml` в одном месте (корень проекта)
- Работает локально в Docker с Xdebug
- Работает в CI GitHub Actions
- Не требует дублирования конфигурации

### Решения

**Вариант 1 (Рекомендуемый)**: Настроить Xdebug в Dockerfile.dev
- Добавить переменную окружения `XDEBUG_MODE=coverage` в Dockerfile.dev
- Или настроить xdebug.mode=coverage в php.ini
- Обновить скрипт `dev` для поддержки coverage

**Вариант 2**: Использовать переменную окружения при запуске
- Добавить опцию `--coverage` в скрипт `dev`
- Устанавливать `XDEBUG_MODE=coverage` только при необходимости

**Вариант 3**: Настроить в phpunit.xml
- Добавить настройки coverage в phpunit.xml
- Но это не решит проблему с XDEBUG_MODE

## План выполнения

### Шаг 1: Настройка Xdebug для coverage
- [ ] Добавить `XDEBUG_MODE=coverage` в Dockerfile.dev или docker-compose.yml
- [ ] Проверить, что coverage генерируется локально
- [ ] Убедиться, что это не ломает другие функции Xdebug

### Шаг 2: Унификация путей
- [ ] Проверить, что coverage.xml генерируется в корне проекта
- [ ] Убедиться, что пути одинаковы в локальном и CI окружении
- [ ] Обновить документацию

### Шаг 3: Обновление скрипта dev
- [ ] Добавить команду `coverage` в скрипт `dev`
- [ ] Или обновить команду `phpunit` для поддержки coverage
- [ ] Проверить работу

## Критерии приемки

✅ Coverage.xml генерируется локально в Docker  
✅ Coverage.xml генерируется в CI GitHub Actions  
✅ Файл создается в одном месте (корень проекта)  
✅ Нет конфликтов между локальным и CI окружением  
✅ Xdebug настроен корректно для coverage

## Технические детали

### Текущая конфигурация

**Dockerfile.dev**:
- Xdebug 3.4.7 установлен
- Но `XDEBUG_MODE` не настроен

**CI workflow**:
- Xdebug настроен через `coverage: xdebug` в setup-php
- Coverage генерируется в корне проекта

**Скрипт dev**:
- Команда `phpunit` не поддерживает coverage опции

### Рекомендуемое решение

1. **Добавить XDEBUG_MODE в docker-compose.yml**:
   ```yaml
   app:
     environment:
       XDEBUG_MODE: develop,coverage
   ```

2. **Обновить скрипт dev**:
   ```bash
   coverage)
       shift
       exec_app vendor/bin/phpunit --configuration=../phpunit.xml --coverage-text --coverage-clover=../coverage.xml "$@"
       ;;
   ```

3. **Или добавить опцию в phpunit команду**:
   ```bash
   phpunit)
       shift
       if [[ "$1" == "--coverage" ]]; then
           shift
           exec_app vendor/bin/phpunit --configuration=../phpunit.xml --coverage-text --coverage-clover=../coverage.xml "$@"
       else
           exec_app vendor/bin/phpunit --configuration=../phpunit.xml "$@"
       fi
       ;;
   ```

## Прогресс

Создано: 2025-01-27

## Заметки

- Xdebug 3.x требует явной настройки режима через XDEBUG_MODE
- Режим `develop,coverage` позволяет использовать и отладку, и coverage
- Нужно убедиться, что это не влияет на производительность в production

