# Task A23: Исправить права доступа для composer install

**Статус**: Completed ✅  
**Приоритет**: High  
**Оценка**: 0.25 дня

## Описание

При выполнении `composer install` в Docker контейнере возникает ошибка создания директории `/var/www/html/vendor/composer`. Директория `vendor` существует, но принадлежит root, что блокирует установку зависимостей от имени пользователя хоста.

## Проблема

**Симптомы**:
```
In Filesystem.php line 261:
/var/www/html/vendor/composer does not exist and could not be created:
```

**Причина**:
- Директория `backend/vendor` на хосте принадлежит root (создана ранее от root)
- Docker контейнер запускается от имени пользователя хоста (`user: "${UID:-1000}:${GID:-1000}"`)
- Composer не может создать поддиректории в `/var/www/html/vendor` из-за прав доступа

**Текущая ситуация**:
```bash
$ ls -la backend/vendor
drwxr-xr-x  2 root root 4096 Nov 30 14:02 .
```

## Решение

**Вариант 1 (Рекомендуемый)**: Исправить права доступа на хосте
- Удалить или пересоздать директорию `backend/vendor` с правильными правами
- Убедиться, что директория принадлежит пользователю хоста

**Вариант 2**: Использовать docker compose с правильными правами
- Запустить `composer install` от root в контейнере
- Затем изменить владельца директории vendor

**Вариант 3**: Добавить в .gitignore и пересоздать
- Удалить vendor из git (если добавлен)
- Пересоздать с правильными правами

## Критерии приемки

✅ `./dev composer install` выполняется успешно  
✅ Директория `backend/vendor` принадлежит пользователю хоста  
✅ PHPUnit доступен в `vendor/bin/phpunit`  
✅ Все зависимости установлены корректно

## Зависимости

- [x] A12: Настроить права доступа в Docker контейнерах (Completed ✅)
- [x] A16: Исправить расположение composer.json (Completed ✅)

## Изменения из CI workflow (задачи A17, A20, A21)

В задачах A17, A20, A21 были исправлены пути для работы в CI, но эти изменения должны работать и локально:

**A20 - Исправлены пути к vendor**:
- ✅ `backend/artisan`: `__DIR__.'/vendor/autoload.php'` (уже исправлено)
- ✅ `backend/public/index.php`: `__DIR__.'/../../vendor/autoload.php'` (уже исправлено)

**Проверка**: Файлы уже содержат правильные пути, но нужно убедиться, что они работают в Docker контейнере.

## Реализация

### Выполненные шаги

#### 1. Проверка текущих прав доступа

✅ **Проблема выявлена**:
- Директория `backend/vendor` принадлежала `root:root`
- Контейнер запускается от имени пользователя хоста (`1000:1000`)
- Composer не мог создавать поддиректории в `/var/www/html/vendor`

#### 2. Исправление прав доступа

✅ **Решение**: Удаление и пересоздание директории vendor с правильными правами
```bash
rm -rf backend/vendor
mkdir -p backend/vendor
chmod 755 backend/vendor
```

**Результат**: Директория `backend/vendor` теперь принадлежит пользователю хоста (`otis:otis`)

#### 3. Установка зависимостей

✅ **Выполнено**: `./dev composer install --no-interaction`
- ✅ Все зависимости установлены успешно (137 пакетов)
- ✅ Autoload файлы сгенерированы
- ✅ Laravel пакеты обнаружены: laravel/sail, laravel/sanctum, laravel/tinker, и др.
- ✅ PHPUnit доступен в `vendor/bin/phpunit`

#### 4. Проверка результата

✅ **Проверено**:
- Директория `backend/vendor` принадлежит пользователю хоста
- Все файлы в `vendor/` имеют правильные права доступа
- PHPUnit доступен и может быть запущен
- Composer install выполняется без ошибок

### Созданные/обновленные файлы

- ✅ `backend/vendor/` - пересоздана с правильными правами доступа
- ✅ Все зависимости установлены корректно

## Проблемы и решения

### Проблема 1: Директория vendor принадлежит root

**Симптомы**: 
```
/var/www/html/vendor/composer does not exist and could not be created
```

**Причина**: Директория `backend/vendor` была создана ранее от имени root (возможно, при сборке Docker образа или при выполнении команд от root).

**Решение**: Удалить и пересоздать директорию vendor с правильными правами:
```bash
rm -rf backend/vendor
mkdir -p backend/vendor
chmod 755 backend/vendor
```

**Реализовано**: Директория пересоздана, права доступа исправлены, composer install работает успешно.

**Примечание**: В docker-compose.yml есть отдельный volume для vendor (`./backend/vendor:/var/www/html/vendor`), что позволяет сохранять зависимости между перезапусками контейнеров. Важно, чтобы эта директория имела правильные права доступа на хосте.

## Связанные задачи

- A20: Исправить скрипт post-autoload-dump в composer.json (Completed ✅ - пути исправлены)
- A24: Исправить пути в конфигурации PHPStan (связано с путями для Docker)
- A25: Исправить пути к конфигурационным файлам в скрипте dev (Completed ✅ - теперь можно запускать тесты)
- B1: Создать модели данных (теперь можно запускать тесты и PHPStan)

## Документирование результатов

### Assumption Log

- **A1**: [Описание предположения] - [Обоснование]

### Успешные решения

- **Решение 1**: [Описание решения] - [Почему оно было эффективным]

### Неверные решения

#### Неверное решение 1: [Краткое название]

**Принятое решение**: [Подробное описание того, что было сделано]

**Обоснование выбора**: [Почему это решение казалось правильным]

**Возникшие проблемы**: 
- [Проблема 1]

**Корректное решение**: [Что было сделано вместо этого]

**Извлеченные уроки**: [Что можно извлечь из этого опыта]

